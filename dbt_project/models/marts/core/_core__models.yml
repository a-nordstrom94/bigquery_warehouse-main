version: 2

models:
  - name: dim_customers
    description: "Primary customer dimension table. Combines geographic attributes with aggregated order history and behavioral segmentation."
    config:
      materialized: table
      schema: gold
    columns:
      - name: customer_id
        description: "Unique identifier for the customer record associated with a specific order."
        tests:
          - not_null
          - unique
      - name: customer_unique_id
        description: "Unique identifier that links the same person across multiple different customer_id records."
      - name: customer_zip_code_prefix
        description: "The first five digits of the customer's zip code."
      - name: customer_city
        description: "City name of the customer's primary address."
      - name: customer_state
        description: "State code (2 letters) of the customer."
      - name: total_orders
        description: "Total count of orders placed by this customer_id."
      - name: total_spend
        description: "Total monetary value spent by this customer across all orders."
      - name: avg_order_value
        description: "Average spend per order (Total Spend / Total Orders)."
      - name: first_order_date
        description: "Timestamp of the very first purchase made by this customer."
      - name: last_order_date
        description: "Timestamp of the most recent purchase."
      - name: days_since_first_order
        description: "Number of days elapsed since the customer's first purchase."
      - name: customer_segment
        description: "Behavioral bucket: Loyal (5+), Repeat (2-4), One-time (1), or No Orders."
      - name: created_at
        description: "Audit column: Record creation timestamp."
      - name: updated_at
        description: "Audit column: Record last update timestamp."

  - name: dim_products
    description: "Product dimension table containing physical attributes, category translations, and calculated dimensions."
    config:
      materialized: table
      schema: gold
    columns:
      - name: product_id
        description: "Unique identifier for the product."
        tests:
          - not_null
          - unique
      - name: product_category_name
        description: "Original product category name in Portuguese."
      - name: product_category_name_english
        description: "English translation of the product category."
      - name: product_name_length
        description: "Number of characters in the product name."
      - name: product_description_length
        description: "Number of characters in the product description."
      - name: product_photos_qty
        description: "Number of photos published for the product."
      - name: product_weight_g
        description: "Product weight measured in grams."
      - name: product_length_cm
        description: "Product length in centimeters."
      - name: product_height_cm
        description: "Product height in centimeters."
      - name: product_width_cm
        description: "Product width in centimeters."
      - name: product_volume_cm3
        description: "Calculated volume of the product (Length x Height x Width)."
      - name: created_at
        description: "Audit column: Record creation timestamp."
      - name: updated_at
        description: "Audit column: Record last update timestamp."

  - name: dim_sellers
    description: "Seller dimension table containing registration details and geographic coordinates (latitude/longitude)."
    config:
      materialized: table
      schema: gold
    columns:
      - name: seller_id
        description: "Unique identifier for the seller."
        tests:
          - not_null
          - unique
      - name: seller_zip_code_prefix
        description: "The first five digits of the seller's registered zip code."
      - name: seller_city
        description: "City where the seller is located."
      - name: seller_state
        description: "Two-letter state code of the seller's location."
      - name: seller_lat
        description: "Latitude coordinate for geographic mapping and distance calculations."
      - name: seller_lng
        description: "Longitude coordinate for geographic mapping and distance calculations."
      - name: created_at
        description: "Audit column: Record creation timestamp."
      - name: updated_at
        description: "Audit column: Record last update timestamp."

  - name: fct_orders
    description: >
      Header-level order facts. This model aggregates payment, item, and delivery metrics 
      into a single row per order. It is incremental, partitioned by purchase date, 
      and clustered by status and customer.
    config:
      materialized: incremental
      unique_key: order_id
    columns:
      - name: order_id
        description: "Unique identifier for the order."
        tests:
          - not_null
          - unique
      - name: customer_id
        description: "Identifier for the customer. Links to dim_customers."
        tests:
          - not_null
          - relationships:
              to: ref('dim_customers')
              field: customer_id
      - name: order_status
        description: "The current state of the order (e.g., delivered, canceled)."
      - name: order_purchase_timestamp
        description: "The date and time the order was placed."
      - name: order_approved_at
        description: "The date and time the order was approved."
      - name: order_delivered_carrier_date
        description: "The date and time the order was delivered to the carrier."
      - name: order_delivered_customer_date
        description: "The date and time the order was delivered to the customer."
      - name: order_estimated_delivery_date
        description: "The estimated delivery date provided at the time of purchase."
      - name: total_payment_value
        description: "Total value paid by the customer, including freight."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 100000
              severity: warn
      - name: payment_count
        description: "Number of payment transactions associated with the order."
      - name: max_installments
        description: "Maximum number of installments used in payment transactions."
      - name: payment_methods_used
        description: "Comma-separated list of payment types used for this order."
      - name: unique_products
        description: "Count of distinct products included in the order."
      - name: total_item_value
        description: "The sum of prices for all items in the order."
      - name: total_freight_value
        description: "The sum of freight charges for all items in the order."
      - name: avg_item_price
        description: "Average price per item in the order."
      - name: total_items
        description: "Total quantity of items in the order."
      - name: order_total
        description: "Order total including freight."
      - name: delivery_days
        description: "Calculated number of days between purchase and customer delivery."
      - name: delivery_status
        description: "Classification: 'On Time' or 'Delayed' based on estimated delivery date."
      - name: hours_to_approval
        description: "Timestamp difference between order confirmation and order approved."
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 8760 # Example: 1 year (to catch extreme outliers)
              severity: warn
      - name: created_at
        description: "Audit column: Record creation timestamp."
      - name: updated_at
        description: "Audit column: Record last update timestamp."

  - name: fct_order_items
    description: >
      Granular fact table at the order-item level. This model is incremental and partitioned by day 
      to optimize query performance and BigQuery costs.
    config:
      materialized: incremental
      unique_key: ['order_id', 'order_item_id']
      incremental_strategy: 'merge'
    columns:
      - name: order_id
        description: "Unique identifier for the order."
        tests:
          - not_null
      - name: order_item_id
        description: "Sequential number identifying the item within the specific order."
        tests:
          - not_null
      - name: product_id
        description: "Unique identifier for the product."
        tests:
          - not_null
          - relationships:
              to: ref('dim_products')
              field: product_id
      - name: seller_id
        description: "Unique identifier for the seller."
        tests:
          - not_null
          - relationships:
              to: ref('dim_sellers')
              field: seller_id
      - name: customer_id
        description: "Identifier for the customer who placed the order."
      - name: order_status
        description: "Current status of the order (e.g., delivered, shipped, canceled)."
      - name: order_purchase_timestamp
        description: "The timestamp when the order was placed. Used for table partitioning."
      - name: product_category_name_english
        description: "Category of the product in English."
      - name: seller_city
        description: "City location of the seller."
      - name: seller_state
        description: "State location of the seller."
      - name: price
        description: "Unit price of the item."
        tests:
          - not_null
      - name: freight_value
        description: "Freight cost associated with this specific item."
      - name: item_total
        description: "Calculated total cost for the item (Price + Freight)."
      - name: created_at
        description: "Audit column: Record creation timestamp."
      - name: updated_at
        description: "Audit column: Record last update timestamp."